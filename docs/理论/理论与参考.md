# 理论与参考

## 动机与定位

- 实现需求：在同一蛋白在无配体（apo）→ 有配体（holo）的结合过程中展示连续的构象通路；现有的生成多在“静态端点”。
- 关键挑战：直接在坐标上学习动力学易受噪声与群对称影响；冻结的强表征（ESM）虽然语义强，但apo/holo的差异在它的高维度向量表示中差异并不明显。
- 解决思路：借助RAE的理论，把ESM作为冻结的表征编码器，辅以几何分支把“局部几何/口袋环境”注入到latent space，从而放大状态差异。在这个latent space中用流匹配、扩散模型、薛定谔桥来学习连续路径。
- 理论依据：RAE强调“冻结预训练编码起+轻量解码器”优于传统VAE类型的潜编解码；蛋白生成已经验证SE(3)流匹配与潜空间/显示混合策略是有效的。https://arxiv.org/abs/2310.02391?utm_source=chatgpt.com、https://www.mlsb.io/papers_2024/ProteinZen%3A_combining_latent_and_SE%283%29_flow_matching_for_all-atom_protein_generation.pdf?utm_source=chatgpt.com

## 编码器：ESM（冻结）+ 几何分支

- ESM-2/3冻结：无需多言
- 几何分支：无需多言
- PLM X 几何融合：参考 PLMGraph-Inter 的范式（PLM嵌入 + 旋转平移不变几何图 + GVP编码）。其在界面接触预测上比单独的PLM有大幅度提升，说明这一做法可以放大与口袋/界面相关的结构信号
- 口袋条件注入：构造“**pocket token**”，对口袋领域节点做 **FiLM/跨注意力**，强调**“会动的区域”**
    
    在几何分支或解码器里，我们有每个残基层 latent $z_i$，还有一个口袋 token $p$（代表整个 pocket 的条件）。
    
    $$
    ⁍
    $$
    
    **直觉：**
    
    - 对口袋邻域残基（权重大）→ $\gamma > 1$，让这些通道放大；
    - 对远离口袋的残基 → $\gamma \approx 1$ 或 $< 1$，保持静态。
    
    这能让网络**自动“聚焦”口袋相关的自由度**。
    

## 解码器：从潜表示到 3D（内坐标优先）

- 我们采用“**内坐标（扭转）→ FK 还原全原子**”的解码头：天然旋/平不敏感，且易于加入**键长/角**软约束。
- **损失**：
    1. **FAPE**（帧对齐点误差，AF2 核心损失之一）——对齐不变、稳定；
    2. **扭转角 wrap L2**（含主链/侧链）；
    3. **距离/接触**图；
    4. **碰撞/几何罚项**（受 ProteinZen 的经验启发，明确建议在全原子解码端加入“clash loss”等几何正则）【[Nature+2bakerlab.org+2](https://www.nature.com/articles/s41586-021-03819-2.pdf?utm_source=chatgpt.com)】。
- **口袋软加权**：所有与残基层有关的项按口袋软权重加权，**聚焦**会动的自由度（口袋、环区等）。
    - 详细介绍
        
        # 解码器与训练细节
        
        > 目标:把潜表示(ESM 冻结 + 几何分支融合后的 per-residue token)解码为全原子 3D 结构,并且让损失函数与生物物理约束一致、数值稳定、对口袋动态自由度更敏感。
        > 
        
        ---
        
        ## 一、为什么选"内坐标(torsion)→ FK(前向运动学)还原全原子"
        
        **核心优势**
        
        - **SE(3) 不敏感**:内坐标用的是**键长 $r$**、**键角 $\theta$**、**二面角 $\varphi$**(扭转角)。整体平移/旋转不会改变这些量,训练更稳。
        - **物理合理**:把大多数"刚性"约束(键长/角)视作常量或轻微正则,只预测"**可动自由度**"(扭转角),天然减少拉断/穿模。
        - **端到端可导**:用 NeRF/TF-NeRF 形式的闭式 FK 公式,从角度连续重建坐标;链式法则即可反传。
        
        ---
        
        ## 二、内坐标解码头:从潜表示到"可动的扭转角"
        
        ### 2.1 预测哪些角?
        
        - **主链三扭转**(每个残基 $i$)$\phi_i = \angle (C_{i-1},N_i,C_{\alpha i},C_i)$$\psi_i = \angle (N_i,C_{\alpha i},C_i,N_{i+1})$$\omega_i = \angle (C_{\alpha i-1},C_{i-1},N_i,C_{\alpha i})$(肽键,常接近 180°,Pro 例外)
        - **侧链扭转** $\chi_{i,1..K_i}$(按残基类型 0–4 个)
        
        > 输出参数化:网络输出 $(\sin,\cos)$ 或单位圆向量,再 atan2 得角度(解决周期性/跳变)。
        > 
        
        ### 2.2 角–坐标变换(FK/NeRF 的"一步放置")
        
        给最近三原子 $p_{k-3},p_{k-2},p_{k-1}$ 与新键的 $(r_k,\theta_k,\varphi_k)$:
        
        1. 建局部正交基:
            
            $$
            ⁍
            $$
            
        2. 在该局部帧下新原子的相对坐标:
            
            $$
            ⁍
            $$
            
        3. **主链**按 $N\to C_\alpha\to C$ 的 Z-matrix 顺序迭代;**侧链**按残基特定的树形拓扑展开。
        4. **环/芳环**:可作为"刚体片"放置,必要时做最小二乘环闭微调(保持可导)。
        
        > 实做细节:归一化与叉积分母加 $\varepsilon$;键长/角取统计常数(或轻正则),仅学习扭转角。
        > 
        
        ---
        
        ## 三、损失函数设计(稳定、物理、可聚焦)
        
        ### 3.1 FAPE(Frame Aligned Point Error)
        
        **目的**:避免整体刚体影响,度量**局部帧**内的点误差。
        
        - 对每个残基 $i$,定义局部帧 $T_i$(由 $N_i, C_{\alpha i}, C_i$ 构造)。
        - 将预测/真值坐标分别变换到该帧:$\hat x' = T_i^{-1}\hat x,\ x' = T_i^{-1}x$。
        - 误差:$\mathrm{FAPE}_i = \mathrm{Huber}(|\hat x' - x'|)$(或裁剪的 L2)。
        - 聚合全残基/选定原子后求平均。**特点**:**旋/平不敏感**、对局部几何变化更敏感,训练稳定(AlphaFold2 的核心度量)。
        
        ### 3.2 扭转角 wrap-L2(主链/侧链)
        
        预测 $\hat\theta$,真值 $\theta$,用周期一致的度量:
        
        - 方式一:$\mathcal L_{\text{tor}} = 1 - \cos(\hat\theta - \theta)$。
        - 方式二:把网络改为输出 $(\sin\theta,\cos\theta)$,对这两者做 L2。**要点**:避免 $\pi$ 与 $-\pi$ 的"假大误差"。
        
        ### 3.3 距离/接触图
        
        - **距离**:对选定原子/残基对 $(i,j)$,最小二乘:$\big(|\hat x_i-\hat x_j| - |x_i-x_j|\big)^2$。
        - **接触**:把距离阈值 $d_c$ 变为软概率(如 $p=\sigma(\alpha(d_c-\hat d))$),做 BCE。**用途**:稳住全局拓扑/口袋界面;与 FAPE 互补。
        
        ### 3.4 几何/碰撞正则(clash & chemistry)
        
        - **Clash**:对非键合原子对施加最小距离惩罚:$\max(0,\ r_\text{vdW}-\hat d_{ab})^2$。
        - **键长/角软约束**(可选):$(\hat r - r_0)^2,\ (\hat\theta-\theta_0)^2$。
        - **手性/平面性**(可选):对芳环/酰胺平面等加入软约束项。**动机**:文献与实践都观察到纯学习式解码易出现轻微穿模/碰撞;加入 clash 与几何先验可显著净化原子级细节。
        
        ### 3.5 总损失(带权重)
        
        $$
        ⁍
        $$
        
        ***起步建议***:$\lambda_{\text{tor}}=1,\ \lambda_{\text{dist}}=0.1,\ \lambda_{\text{cont}}=0.1,\ \lambda_{\text{geo}}=0.1$。训练稳定后再微调权重。
        
        ---
        
        ## 四、口袋**软加权**(聚焦会动自由度)
        
        **思路**:给每个残基一个权重 $w_i\in[0,1]$(由配体距离、接触膨胀、RBF 衰减等生成),把所有**与残基相关**的损失项**按 $w_i$ 加权**;对成对项用 $\tilde w_{ij}=\max(w_i,w_j)$。
        
        - **加权示例**
            
            $$
            ⁍
            $$
            
        - **效果**
            - 训练初期:**强化口袋/环区**的梯度,快速学到"会动的地方怎么动"。
            - 训练后期:**逐步放宽**口袋半径或降低权重差,让全局协调被补齐。
        - **实现**:软权重生成参考你现有方案(接触半径 + 图膨胀 + RBF/高斯衰减),并导出 pocket token 用于条件调制(FiLM/跨注意力)。
        
        ---
        
        ## 五、与生成器(FM/SB)的衔接
        
        - 解码器要**适应生成阶段的噪声**:训练时给潜表示 $Z$ 加小噪声(与后续流/桥采样的一致),或对解码器输入使用"噪声增强训法",可显著减少"训练–生成分布偏移"。
        - 在潜空间学连续路径(CFM 或 SB)后,**每个中间态 $Z_t$** 直接喂给本解码器,即可获得**连续的 3D 动态帧**;碰撞/接触等几何项也可对中间帧施加为**路径正则**(如口袋接触概率随 $t$ 近似非减)。
        
        ---
        
        ## 六、训练与工程要点(可直接照做)
        
        - **输出**:$(\sin,\cos)$ 形式的 $\phi,\psi,\omega,\chi$;Pro/cis-trans 可加一个二分类辅助头。
        - **FK**:NeRF/TF-NeRF,数值稳定处理 $\varepsilon$;先主链后侧链;芳环用刚体片或环闭微调。
        - **优化**:AdamW;bf16 混合精度;梯度裁剪 1.0;EMA 0.999;先把**端点重建**训稳,再叠加**对比/Δ监督**与路径学习。
        - **评测**:
            - 全局:主链/全原子 RMSD、FAPE、clash%
            - 口袋:iRMSD、接触/氢键命中率
            - 角度:Ramachandran 合规率、$\chi$ 命中率(±20°)
        
        ---
        
        ## 八、给导师的"要点金句
        
        - **解码头选择**:"**内坐标(扭转)→ FK 还原**"天然对 **SE(3)** 不敏感,能把学习集中在**真正的自由度**上(主链 $\phi,\psi,\omega$ 与侧链 $\chi$)。
        - **核心损失**:**FAPE**(对齐不变、稳定) + **wrap-L2 扭转**(直击自由度) + **距离/接触**(保拓扑) + **clash/几何正则**(净化全原子细节)。
        - **口袋软加权**:对口袋与环区**提升权重**,让模型首先学会"哪里会动、怎么动";后期再**放宽**以补上全局协调。
        - **与生成衔接**:潜空间上学的 **连续路径** $Z_t$ 逐帧喂入同一解码器,即得平滑的 **apo→holo 动态**;中间帧也可施加接触单调性/碰撞约束作为路径正则。
        
        ---
        

## 潜空间里的连续生成：CFM 与/或 SB

- **流匹配（CFM/FM）**：以**潜 token**为状态，学习从 apo 分布到 holo 条件分布的**速度场**；蛋白领域已有 **FoldFlow/FoldFlow‑2** 证明了在 **SE(3)** 与**序列条件**下做流匹配的可行性与稳定性（ICLR 2024）【[arXiv+2ICLR Proceedings+2](https://arxiv.org/abs/2310.02391?utm_source=chatgpt.com)】。
    
    ![image.png](%E7%90%86%E8%AE%BA%E4%B8%8E%E5%8F%82%E8%80%83%202941c8dac6f3805b8b65fbc82ca4bbc1/image.png)
    
- **施罗丁格桥（SB）**：当端点（apo/holo）已知时，SB 在“参考扩散”下找到**KL 代价最小**的桥路径；**SBALIGN** 已在**蛋白对接/构象变化**子问题中给出实证（UAI/ICML 2023），**DiSCO** 用 SB 做**分子构象**优化也显著提升了多样性与质量，说明 SB 能自然处理“多稳态/能垒穿越”的**路径生成**【[Proceedings of Machine Learning Research+2arXiv+2](https://proceedings.mlr.press/v216/somnath23a/somnath23a.pdf?utm_source=chatgpt.com)】。

![image.png](%E7%90%86%E8%AE%BA%E4%B8%8E%E5%8F%82%E8%80%83%202941c8dac6f3805b8b65fbc82ca4bbc1/image%201.png)

中间公式的意思是：粒子沿着噪声 $dW_t$随机游走，同时受到“要靠近终点 $x_1$”的引力。

左边是蛋白和配体还没有结合的状态，也就是 $x_0$，右边是结合后的状态 $x_1$。传统的扩散模型只知道两边的分布，却不知道这种一一对应关系，所以学出来的转化路径往往比较模糊。

而 SBALIGN 的做法是：在中间构造一个“布朗桥”（Brownian bridge），让粒子从 $x_0$ 随机走到 $x_1$，再通过一个可学习的漂移项 $b_t^\theta$ 和修正项 $\nabla \log h_t^\theta$ 去调整这条路径。

这样模型既能捕捉真实的动态变化，又能保证从起点走到正确的终点。

所以简单来说，这个方法就是**利用成对的对齐信息来引导扩散过程，从而让生成的轨迹更真实、更稳定**。

- **扩散模型（Diffusion）：**

![image.png](%E7%90%86%E8%AE%BA%E4%B8%8E%E5%8F%82%E8%80%83%202941c8dac6f3805b8b65fbc82ca4bbc1/image%202.png)

- **Pipeline解析**
    
    ## A）总体框架：在**潜空间**里做扩散，再解码到全原子
    
    - 左侧一叠蛋白结构/轨迹帧先进入 **VAE**：
        - **E**（encoder）把每个残基压到一个**12 维**的潜向量，得到"潜轨迹" $x_0$；**D**（decoder）把潜向量还原为**全原子坐标**。这么做的目的是把离散、受物理约束的 3D 结构，映到更**连通**、更易建模的空间。
    - 右侧是 **扩散过程**：在潜空间对轨迹加噪得到 $x_t$，然后用**潜空间去噪 Transformer（LDT）从噪声逐步还原。去噪时可条件在氨基酸序列** $s$ 和**条件帧** $x_{\text{cond}}$（如起点/终点帧），从而实现"给定起点往前推演"或"在两态间补齐路径"。
    
    ---
    
    ## B）LDT 的骨架：**Input Embedder → 多层 Dynaformer**
    
    - **Input Embedder** 把输入统一成两条表征：
        - **$p^0$**：蛋白级表征（聚合了序列与条件帧的全局信息）；
        - **$x_e^0$**：轨迹级表征（每帧、每残基的潜特征）。
    - 然后堆叠 **N 个 Dynaformer** 模块迭代更新这两条表征，最后输出去噪后的潜轨迹。图里底部那叠"蓝色小方块"就是逐层更干净的潜轨迹特征。
    
    ---
    
    ## C）Input Embedder 的三路输入与对齐
    
    - **Noising Trajectory Embed**：把带噪潜轨迹（$x_t$）线性投影进模型的"轨迹通道"。
    - **Condition Frames Embed**：把被指定为条件的帧（常见是**第一帧**，也可包含终态帧）与其**掩码**做编码，用来"锚定"生成过程。
    - **Sequence Embed（ESM2-650M）**：先用蛋白语言模型 ESM2 提取每残基与全序列的表征，再线性投影并与上两路对齐，得到蛋白级的上下文。最后拼装成 $p^0$ 与 $x_e^0$。这样做把"**序列信息** + **结构锚点** + **当前带噪轨迹**"放到同一坐标系里。
    
    ---
    
    ## D）Dynaformer 单元：先"**空间注意力**"，再"**时间注意力**"，双表征交替更新
    
    - **Spatial Attention**：在**同一帧**的残基×残基上做注意力，学习"同一时刻的三维构象内相互作用"。
    - **Temporal Attention**：在**同一残基**的**帧序列**上做注意力，学习"该残基随时间的动力学"。
    - **Traj. Rep. Update → Prot. Rep. Update**：
        1. 用注意力后的轨迹信息更新轨迹表征；
        2. 将轨迹的**平均信息**与蛋白表征拼接，更新蛋白表征；
        3. 再把更新后的蛋白表征回灌到轨迹通道（图里的"+"是残差连接）。
            
            这一"**空间→时间→双向更新**"循环堆叠多次，逐步把噪声去掉。
            
    
    ---
    
    ## 图外但关键的实现细节（与本图配套理解）
    
    - **为什么选潜空间**：论文强调 VAE 训练后把"物理可行的构象子流形"拉直成更**连续**的潜空间，便于扩散/插值与条件路径学习；直接在 3D 做插值会出现不合理折叠。
    - **训练信号与时间条件**：LDT 在潜空间上用 **EDM** 去噪目标；扩散步长/噪声水平会被投影成缩放与偏置，注入到注意力/MLP 中，配合 RoPE 位置编码处理时序。
    - **输入来源**：VAE 的编码器吃**主链**、解码器出**全原子**；序列端完全靠 **ESM2**（不依赖 MSA），每残基压到**12 维**潜特征后再做扩散。
    
    ---
    
    ## 一句话把这图串起来
    
    > 先用 VAE 把"轨迹帧的全原子结构"压进一个易学习的潜轨迹；再在这个潜空间里用带条件的扩散 + LDT（"空间注意力 + 时间注意力 + 蛋白/轨迹表征交替更新"）完成去噪，最后由解码器还原成全原子轨迹/构象集合。这样既能做前向推演，也能在两态间补轨。
    > 
- **与 RAE 的耦合**：RAE 文献强调**在冻结表示的高维潜空间**上训练生成器（DiT+FM）可带来更快收敛/更好样本质量；我们把这一经验迁移到蛋白场景（潜空间改为“序列语义+几何”融合 token），并采用**解码器噪声增强**来提升对生成阶段噪声的鲁棒性【[arXiv+1](https://arxiv.org/html/2510.11690v1?utm_source=chatgpt.com)】。
- **混合显式/潜空间**策略：参考 **ProteinZen/La‑Proteina**——前者把**骨架帧**放在 SE(3) 显式流、**全原子细节**放在潜表示；后者把 **Cα 显式**、**其余原子/序列**进潜表示，均取得强结果，支撑我们把“难显式、噪声大的细节”留在潜空间里学路径【[MLSB+2arXiv+2](https://www.mlsb.io/papers_2024/ProteinZen%3A_combining_latent_and_SE%283%29_flow_matching_for_all-atom_protein_generation.pdf?utm_source=chatgpt.com)】。

## 生物化学‑物理限制（连续路径的“护栏”）

- **几何约束**：键长/角软约束、**clash** 惩罚（全原子）、手性/支链约束；ProteinZen 明确观察到“偶发碰撞”，建议引入 clash loss，这与我们的思路一致【[MLSB](https://www.mlsb.io/papers_2024/ProteinZen%3A_combining_latent_and_SE%283%29_flow_matching_for_all-atom_protein_generation.pdf?utm_source=chatgpt.com)】。
- **能量/接触先验**：可借鉴 trRosetta 将**距离/取向分布**转成能量约束的传统做法，弱监督地“扶正”中间帧【[bakerlab.org](https://www.bakerlab.org/wp-content/uploads/2022/01/Du_etal_NatProt2021_trRosetta_server.pdf?utm_source=chatgpt.com)】。
- **口袋单调性（软约束）**：路径上口袋接触概率随 $t$ 近似非减（允许小噪动），提升路径可解释性。

## 口袋信息如何“放大差异”？

- **数据侧**：用 **sc‑PDB** / **LVPocket** 获取口袋坐标/掩码/中心，构造**软口袋权重**与 **pocket token**；LVPocket 证明了“**全局+局部**”的口袋表征比单一尺度强，可直接指导我们做**多尺度几何分支**（局部半径图 + 远程补充图）【[bioinfo-pharma.u-strasbg.fr+1](https://bioinfo-pharma.u-strasbg.fr/scPDB/?utm_source=chatgpt.com)】。
- **模型侧**：只对**口袋邻域**施加更强的重建/对比/Δ‑监督（例如 Δ‑torsion、Δ‑contact），把“**状态差异**”装进**潜空间的特定子空间**，既不破坏全局语义，又显著提升 **apo/holo 可分性**（这一步有 PLM×几何融合提升界面信号的事实支撑）【[eLife](https://elifesciences.org/articles/92184?utm_source=chatgpt.com)】。

---

## 与“他人做法”的对齐与区分（Related → Ours）

- **与 RAE（视觉）**：我们严格沿用“冻结表示编码器 + 轻量解码器 + 潜空间生成”的主框架，只是把编码器换成 **ESM**、解码目标换成**3D 内坐标**，生成器换成“**潜空间 FM/SB**”。视觉 RAE 明确主张“**冻结编码器**”是优选【[arXiv](https://arxiv.org/html/2510.11690v1?utm_source=chatgpt.com)】。
- **与 FoldFlow/Proteina（纯 SE(3) 生成）**：我们不是只在 SE(3) 坐标上学，而是**将难显式的自由度放入潜空间**，与 **ProteinZen/La‑Proteina** 的混合思路一致；这有助于提升稳定性与细节质量【[arXiv+2MLSB+2](https://arxiv.org/abs/2310.02391?utm_source=chatgpt.com)】。
- **与 PLMGraph‑Inter/ProtSSN（PLM×几何）**：他们证明了**PLM + 等变几何图**能显著强化界面/口袋表征；我们进一步把这套融合的**潜表示**作为**生成的状态空间**，把**动态通路**学出来（而非只做静态预测）【[eLife](https://elifesciences.org/articles/92184?utm_source=chatgpt.com)】。
- **与 SBALIGN/DiSCO（SB 应用于结构路径）**：他们在对接/构象优化上已验证 SB；我们把 SB/CFM 放到**ESM‑几何融合潜空间**里学 **apo→holo 连续路径**，更贴近真实结合过程【[Proceedings of Machine Learning Research+1](https://proceedings.mlr.press/v216/somnath23a/somnath23a.pdf?utm_source=chatgpt.com)】。

## 与DeepSeeKOCR融合

**DeepSeek‑OCR 启发的 token 预算**：

- 为了“聚焦口袋”，仿照 **Tiny/Small/Base/Gundam** 多模式，把全蛋白图做成“**全局视图 + 口袋 tiles**”，给口袋邻域**更多token/更高分辨率**，远端区**更少token**（相当于“视觉中的动态分辨率”）。