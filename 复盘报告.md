# BINDRAE 配体表示与 χ1 精度优化阶段复盘报告

## 1. 背景与目标

本阶段工作的核心目标是：在 **配体条件化的蛋白构象生成** 框架下，系统评估和优化 **配体表示方式**，特别是：

- 氢原子（尤其是极性氢）的处理策略；
- 氢键供体/受体（HBD/HBA）等关键化学环境的表示方式；
- 这些设计对 **侧链 χ1 准确率** 的具体影响。

模型整体架构基于 Stage-1：

- 上游使用冻结的 ESM 表征；
- 通过 FlashIPA 完成几何推理；
- 以 FK 模块重建全原子结构；
- 关键监督指标之一为 **侧链 χ1 准确率**。

基准模型在 CASF-2016 上曾达到约 **71% 的 χ1 准确率**，本阶段工作在此基础上进行一系列表示与超参数上的改动与回退。

---

## 2. 方案设计与实现

### 2.1 原始基线方案（成功方案）

**原始版本的核心设计：**

- **氢原子处理**：使用 RDKit `RemoveHs`，**移除所有氢原子**；
- **配体几何表示**：
  - 输入为配体重原子坐标；
  - 利用 RDKit ChemicalFeatures 检测 HBD/HBA、芳香原子、带电原子；
  - 为 HBD/HBA/芳香/带电等关键原子生成 **方向探针（directional probes）**：
    - 探针距离约 1.5 Å；
    - 方向基于邻近原子几何（键方向、环平面法向等）；
    - 每个原子最多 1–2 个探针；
- **原子类型编码**：
  - 12 维 one-hot：`C N O S P F Cl Br I aromatic positive negative`；
  - 不包含氢原子类型；
- **重要性采样**：
  - 上限 `MAX_LIGAND_TOKENS = 128`；
  - 优先级：HBD/HBA 重原子及其探针 > 带电 > 芳香 > 其他；
  - 探针权重（示意）：HBD/HBA 探针 ≈ 3.0，带电探针 ≈ 2.0，芳香探针 ≈ 1.0，普通探针 ≈ 0.5；
- **模型输入**：
  - 配体 token：坐标 (3) + 类型 (12) → 15 维；
  - 通过 [LigandTokenEmbedding](cci:2://file:///Users/apple/code/BINDRAE/src/stage1/models/ligand_condition.py:47:0-93:24) 映射到内部通道维度后，与蛋白表示进行 cross-attention 条件化。

在此配置下，Stage-1 在 CASF-2016 上达到约 **71% 的 χ1 准确率**。

---

### 2.2 方案 A：保留极性氢的尝试（失败）

**动机**：显式保留极性氢（N–H / O–H / S–H），期望更精确地表达氢键方向和供体位置。

**实现要点：**

- 使用 RDKit `AddHs(mol, addCoords=True)` 生成氢原子坐标；
- 保留与 N/O/S 连接的极性氢，删除非极性氢；
- 在重要性采样和注意力权重中显著提高极性氢的权重，使其成为高优先级 token；
- HBA 仍通过探针表示，HBD 则部分由真实极性氢坐标表达。

**实验结果：**

- 初始版本（极性氢权重较高）：χ1 ≈ **63%**；
- 调低极性氢权重（尝试弱化其影响）：χ1 进一步降至 ≈ **57%**。

**结论：**

1. RDKit 基于几何规则生成的氢原子，特别是极性氢，其坐标误差较大；
2. 当这些“合成的”氢坐标被赋予较高权重时，模型会过度依赖噪声信息，显著损伤整体 χ1 精度；
3. 即使降低极性氢权重，整体性能仍明显劣化，说明引入这些坐标本身就是高风险操作。

**阶段性判断**：  
> “保留极性氢 + 提升其权重”作为一般策略是不成立的，应回避这一方向。

---

### 2.3 方案 B：回退到无氢 + 探针表示 HBD（修复）

在确认方案 A 失败后，重新回到“完全移除氢 + 用探针表示 HBD/HBA”的路线，并进行更系统的整理。

**主要修改：**

1. **预处理脚本 [prepare_ligands.py](cci:7://file:///Users/apple/code/BINDRAE/scripts/prepare_ligands.py:0:0-0:0)**  
   - 统一使用 `Chem.RemoveAllHs(mol)`；
   - 坐标文件仅包含重原子；
   - SDF 与坐标的一致性通过专门脚本 `verify_ligand_consistency.py` 严格检查，要求原子数 100% 一致。

2. **[ligand_utils.py](cci:7://file:///Users/apple/code/BINDRAE/utils/ligand_utils.py:0:0-0:0) 中的表示与权重调整**  
   - 确认/恢复原始 12 维类型编码（去掉 H 类型）；
   - [_analyze_atoms](cci:1://file:///Users/apple/code/BINDRAE/utils/ligand_utils.py:157:4-216:19) 部分改为严格一致性检查，不再“取最小值凑合用”，而是发现不一致就直接报错；
   - [_generate_probes](cci:1://file:///Users/apple/code/BINDRAE/utils/ligand_utils.py:218:4-274:83)：
     - 明确为 **HBD 和 HBA** 重原子都生成探针；
     - 芳香和带电原子也可生成探针，以表达 π-π 与静电方向性；
   - [_importance_sampling](cci:1://file:///Users/apple/code/BINDRAE/utils/ligand_utils.py:327:4-400:27)：
     - 初始尝试中，曾人为抬高探针权重（HBD/HBA 探针权重过高），导致性能下降至 ~56%；
     - 后对照早期 commit，将探针权重恢复到**原始风格**：
       - HBD/HBA 探针 ≈ 3.0；
       - 带电探针 ≈ 2.0；
       - 芳香探针 ≈ 1.0；
       - 普通探针 ≈ 0.5；
       - HBD/HBA 重原子在基础分上再加 5.0；
   - [_compute_importance](cci:1://file:///Users/apple/code/BINDRAE/utils/ligand_utils.py:433:4-466:25)（注意力权重）：
     - 保持简单的加权策略：HBD/HBA 重原子 +0.3、带电原子 +0.2，并裁剪到 [0,1]。

3. **数据管线和模型输入维度统一回退**  
   - [dataset_ipa.py](cci:7://file:///Users/apple/code/BINDRAE/src/stage1/datasets/dataset_ipa.py:0:0-0:0)：配体类型维度从 13 改回 12；
   - [LigandTokenEmbedding](cci:2://file:///Users/apple/code/BINDRAE/src/stage1/models/ligand_condition.py:47:0-93:24)：输入维度从 16（3+13）改为 15（3+12）。

**实验结果：**

- 在修复重要性采样权重、恢复类型维度和模型输入后：
  - batch_size = 8，lr 按线性规则放大；
  - Val χ1 ≈ **67.8%**（最佳 epoch Val Loss ≈ 0.198）。

与方案 A（57–63%）相比，性能有明显回升；与原始 71% 相比仍有约 3–4 个百分点差距，初步判断主要来自：

- 训练超参数（batch_size、学习率、early stopping 等）与最初基线略有不同；
- 随机性与训练时长差异。

---

## 3. 总体分析与阶段性结论

通过多轮对比实验，可以归纳出几条比较清晰的结论：

### 3.1 结论 1：不保留氢 + 探针表示 HBD/HBA 是合理基线

- 在 RemoveAllHs 的前提下，通过在重原子上放置方向探针，既避免了 RDKit 氢坐标的不确定性，又保留了氢键方向性等关键信息；
- 当探针的权重设置接近早期成功版本时，模型可以达到 **67–71% 的 χ1 准确率**，表现稳定；
- 从实现上看，这一方案与项目中《LIGAND_PROBES_EXPLAINED》文档强调的“显式方向性表示 + 稀疏 token 化”是高度一致的。

### 3.2 结论 2：AddHs 生成的极性氢坐标不宜直接作为高权重特征使用

- RDKit `AddHs` 基于几何规则“补氢”，缺乏能量优化，坐标偏差较大；
- 当这些极性氢被赋予高权重，模型倾向于“相信”这些噪声方向，导致 χ1 从 71% 降到 63%，进一步调参甚至跌到 57%；
- 这说明，除非有更高质量的氢坐标（例如 QM 或高精度 MD），否则不建议在这一阶段显式保留极性氢。

### 3.3 结论 3：探针的“存在”是有益的，但权重需要谨慎设置

- 实验表明，只要权重恢复到早期风格（探针相对重原子适度偏高，而非过度），性能就能从 56% 回到接近 68%；
- 说明探针本身提供了对氢键、芳香、静电相互作用方向的有用信息，但一旦在采样和注意力中权重过大，会压制其它重要几何信号（例如 backbone、非极性环境），反而有害。

---

## 4. 文献视角下的 χ1 水平定位

参考 Peterson 等人在 2016 年的工作  
*“Assessment of Protein Side-Chain Conformation Prediction Methods in Different Residue Environments”*（PMC5007623）：

- 该文评估了 8 种经典侧链构象预测方法（SCWRL4、Rosetta、OSCAR 等），在 PDB 实验结构上比较其 χ1 和 χ1&2 准确率；
- 主要结论：
  - **大多数方法的 per-protein median χ1 > 80%**；
  - 最好的方法（OSCAR 系列）χ1 接近 **90%**；
  - χ1&2 一般比 χ1 低 10–20 个百分点。

需要强调的是，文献中的设置通常是：

- 主链构象已知且基本正确；
- 任务是 “给定 backbone，预测最合适的侧链 rotamer”。

而本项目的任务更为复杂：

- 同时预测 backbone 和 side-chain 构象；
- 并显式考虑 **配体存在导致的局部构象变化**；
- 训练数据规模和建模目标与专门的侧链 packer 有明显差异。

因此，单纯从数字上比较：

- 文献专用侧链预测工具：χ1 ≈ 80–90%（上界）；
- 本项目 Stage-1：
  - 早期基线：χ1 ≈ 71%；
  - 当前修复方案：χ1 ≈ 67.8%。

可以认为，本项目目前的 χ1 水平处于：

> “相对于专门 rotamer 方法略低一档，但在 joint、ligand-conditioned、数据规模有限的设置下处于合理中档水平，仍有一定提升空间”。

---

## 5. 后续优化方向建议

在确认“RemoveAllHs + HBD/HBA/芳香/带电探针 + 12D 类型编码 + 原始风格权重”是一个稳定基线后，后续优化建议集中在以下几个方向，而不再围绕“显式极性氢”反复迭代。

### 5.1 优化一：训练配置与损失设计（低风险，优先级高）

- **训练超参数微调**
  - 重点扫描：
    - batch_size ∈ {4, 8}；
    - 学习率 lr ∈ {1e-4, 1.5e-4, 2e-4}；
    - warmup steps ∈ {500, 1000}；
  - 目标：在不改结构和表示的情况下，将 χ1 从 67–71% 再推高 2–3 个百分点，并提高稳定性。

- **增加 χ1 友好的辅助损失**
  - 在现有 torsion/L2 损失基础上：
    - 引入 χ1 rotamer 分类头，将 χ1 离散为 g⁻/g⁺/t 等区域，使用交叉熵监督；
    - 或结合 Dunbrack 风格 rotamer 概率，构建 backbone-dependent rotamer 正则。
  - 文献表明，此类设计对 χ1 指标通常有直接帮助。

### 5.2 优化二：增强配体条件化，而不是继续纠结氢表示（中风险，收益潜力大）

- **多层配体条件化**
  - 目前配体条件化在模型中出现的层次较有限；
  - 可以考虑在 IPA 多个层中注入 ligand-conditioned 表示，使蛋白在多个尺度反复“看到”配体。

- **适度丰富配体特征**
  - 在 12 维类型 one-hot 基础上，引入少量额外 scalar 特征：
    - RDKit hybridization（sp2/sp3）、是否在环上、局部 partial charge、HBD/HBA 计数等；
  - 通过小型 MLP 投影到固定维度后拼接，不显著增加整体输入维度。

### 5.3 优化三：深入挖掘 probe 设计（研究型方向）

- 调整探针几何参数：
  - 测试不同探针距离（如 1.2 / 1.5 / 2.0 Å）对 χ1 的影响；
  - 对芳香环引入区分 π-π stacking / T-shaped stacking 的不同 probe 方向设计。

- 在几何模块中显式利用 probe：
  - 在边特征中加入 protein residue ↔ probe 的方向/距离编码；
  - 将 probe 视为“潜在相互作用位点”，而不仅是 ligand 点云的增强。

### 5.4 优化四：数据与任务层面的长期扩展（中长期）

- 将数据集从 CASF-2016 扩展到更大规模的配体–蛋白复合物库（如 PDBbind 等），在保持预处理严格性的前提下提升多样性；
- 在后续 Stage-2（连续路径学习）中，引入中间状态的弱监督或正则，使构象路径更加光滑和物理合理。

---

## 6. 小结

- 当前阶段已经基本排除了“极性氢显式保留”的方向，确认了 **RemoveAllHs + HBD/HBA/芳香/带电探针** 是配体表示的稳健方案；
- 重要性采样和权重设计对性能影响极大，恢复原始风格的探针权重后，χ1 从 56% 回升到接近 68%，说明探针本身是有效的；
- 与文献中专门的侧链预测工具相比，目前 χ1 水平仍有一定差距，但考虑到任务复杂度和建模目标，这一结果是合理的；
- 后续优化重点，应从 **训练配置、损失设计、配体条件化结构和数据规模** 四个维度展开，而不再围绕氢原子表示反复尝试。
